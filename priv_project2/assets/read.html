<!DOCTYPE html>
<html>
  <head>
      <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
    src="https://code.jquery.com/jquery-3.5.1.js"
    integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc="
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
    integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
    crossorigin="anonymous"
  ></script>
  

  <script>
    $(document).ready(function () {
        channelHead();
        readPost();
        readComment();
      });

      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const channelName = urlParams.get('channel').split('?')[0];
      const postId = urlParams.get('channel').split('?')[1].split('=')[1];

      function channelHead() {
        if (channelName === "node") {
          name = 'NODE.JS';
        } else {
          name = channelName.toUpperCase();
        }
        $('#channelHeader').empty();
        let headTempHtml = `<h1
                              class = "writeHead"
                              onclick="location.href='/${channelName}'"
                            >
                            ${name} 채널
                            </h1>`;
        $('#channelHeader').append(headTempHtml);
      };
    
      function readPost(){
        $("#postDetails").empty();
        $.ajax({
          type: "GET",
          url: `posts/read/${postId}`,
          data: {},
          success: function (response) {
            const post = response['post'][0];
            console.log(post['title'])
            let posthtml = ` <h1 style="color: azure;font-family: Sam3KRFont;">${post['title']}</h1>
                              <div style="color: azure;font-family: Sam3KRFont;">
                                  <span>${post['nickname']}</span> 
                                  <span style="color: rgb(131, 131, 131);"> | </span>
                                  <span>2021/07/01 16:42:32</span>
                                  <span style="float: right;">추천: ${post['like'].length}</span>
                                  <span style="color: rgb(131, 131, 131); float: right;
                                  margin-left: 5px;margin-right: 5px;"> | </span>
                                  <span style="float: right;"> 조회: ${post['view']}</span>
                                  
                                  <p style="margin-top: 30px;">${post['context']}</p>

                              </div>`
            $("#postDetails").append(posthtml);                  
          }
      })
    };

    function readComment(){
      $("#pastComment").empty();
      $.ajax({
          type: "GET",
          url: `comments/read/${postId}`,
          data: {},
          success: function (response) {
            const comment = response['comment'];
            for (let i = 0; i < comment.length; i++) {
              makeComment(comment[i])
            }
    }
  })
};

    function makeComment(comment){
      let commentHtml = `<div class="pastCommentUser" style="margin-top: 30px;">${comment['nickname']}</div>
                          <div id="pastCommentContex" class="pastCommentContext"placeholder="comment">${comment['comment']} </div>
                        </div>`
      $("#pastComment").append(commentHtml);
    }
    function writeCommnet(){
        getSelf();
        
      }

      function getSelf(callback) {
      $.ajax({
        type: "GET",
        url: "/users/info",
        headers: {
          authorization: `Bearer ${localStorage.getItem("token")}`,
        },
        success: function (response) {
          getCommentData(response.user);
        },
      });
    }  

      function getCommentData(user) {
        let comment = $('#newComment').val();
        let userId = user.id;
        let nickname = user.nickname;

        $.ajax({
          type: 'POST',
          url: '/comments/write',
          data: {
            comment : comment,
            postId : postId,
            userId : userId,
            nickname : nickname
          },
          success: function (response) {
              alert('쓰기완료');
              window.location.reload();
          },
          error: function (error) {
            alert(error.responseJSON.errorMessage);
          },
        });
      }
  </script>
    <title>제목으로 바꿔</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./mystyle.css" />
  </head>
  <body bgcolor="rgb(21,115,149)">
    <div class="listWrap">
      <div id = "channelHeader">
        <h1
          style="
            color: rgb(22, 209, 147);
            text-align: left;
            cursor: pointer;
            width: 300px;
            font-family: Sam3KRFont;
            font-size: 50px;
            margin-bottom: 10px;
          "
          onclick="location.href='node.html'"
        >
          NODE.JS 채널
        </h1>
      </div>
      <div
        id = "postDetails"
        style="border-top: 2px dashed azure; width: 1060px;"
      >
        <h1 style="color: azure;font-family: Sam3KRFont;">제목</h1>
        <div style="color: azure;font-family: Sam3KRFont;">
            <span>닉네임</span> 
            <span style="color: rgb(131, 131, 131);"> | </span>
            <span>2021/07/01 16:42:32</span>
            <span style="float: right;">추천: 32</span>
            <span style="color: rgb(131, 131, 131); float: right;
             margin-left: 5px;margin-right: 5px;"> | </span>
            <span style="float: right;"> 조회: 22</span>
            
            <textarea style=" margin-top: 30px;">내용</textarea>

        </div>
        </div>
        <div style="color: azure;font-family: Sam3KRFont; margin-top: 100px; border-top: 2px dashed azure; width: 1065px; font-size: 30px; padding-top: 20px;"> 댓글 </div>
        <div>
          <div style="margin-top: 30px;">
            <div  id= 'pastComment' >
            <div class="pastCommentUser">닉네임</div>
            <div id="pastCommentContex" class="pastCommentContext"placeholder="comment">안녕하세요 지금은 테스중</div>
          </div>
          </div>
        </div>
        
        <input type="text" id="newComment" style="
        color: azure;
        background-color: transparent;
        border: transparent;
        width: 1000px;
        height: 50px;
        margin-top: 30px;
        font-size: 20px;
        font-family: Sam3KRFont;
        border: 2px dashed azure;
      "
      placeholder="comment">
      <input type="submit" id="submit" style="color: azure;
      background-color: transparent;
      border: transparent;margin-top: 30px;
        font-size: 20px;
        font-family: Sam3KRFont; cursor: pointer;" onclick="writeCommnet()">

      </div>
    </div>
    <div class="alertBox"></div>
  </body>
  <footer style="height: 400px;">

  </footer>
</html>
